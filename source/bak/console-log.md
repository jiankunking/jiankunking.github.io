---
title: 云原生场景下的日志解决方案
abbrlink: 15644
date: 2021-06-10 15:38:13
tags:
---

# 背景
近年来随着以 Kubernetes 为代表的云原生技术的崛起，应用上云是大势所趋，随之而来的问题是应用日志的收集、查看、检索等问题。

云原生时代的日志有以下几个特点/痛点：
* 日志更多
在应用上云之前，大多数应用都是运行在某个服务器上，每个应用程序通常仅生成一个日志。现在随着应用上云、落地微服务架构，服务之间的依赖关系越来越复杂了，排查问题时如何关联各个维度、服务的日志将是一个困难的问题。
* 多样化日志结构
在上云之后，绝大多数的开发者都习惯于通过终端输出日志，但这些日志有的是一条普通文本，有的是一条json，如何兼顾多种日志结构，满足不同的业务需求？
* 环境的动态性变强
在Kubernetes中，机器下线、上线、Pod销毁、扩容/缩容等都是常态，这种情况下日志的存在是瞬时的（例如如果Pod销毁后该Pod日志就不可见了），所以日志数据必须实时采集到存储系统。
* 日志与Trace
当应用开发者根据 Trace 定位到问题模块、方法的时候，如何查看该请求对应的日志上下文？
当应用开发者在日志中发现一个异常的时候，如何查看该日志对应请求的Trace上下文？

# 解决方案

针对云原生场景下的日志需求，我们开发者平台提供了以下核心能力：
## 实时日志
选择具体应用-具体实例-查看实时日志。

## 离线(近实时)日志
* 服务与日志的打通：只需简单下拉选择就可以精确定位到某个应用实例的日志。
* 日志检索
	* 多关键关键字搜索：比如想搜索日志中包含error并且包含found的，则在搜索框输入error AND found即可。
	* 关键词完整匹配：比如想搜索account-api.haier.net，则可以在搜索框输入"account-api.haier.net"
	* 日志上下文：支持检索出某条日志后，可以查看上下文。上下文是指将该日志在原始文件中的前若干条（上文）或后若干条日志（下文）也查找出来。通过查看指定日志的上下文信息，您可以在业务故障排查中快速查找相关故障信息，方便定位问题。
* 日志处理
	* 日志结构提取与存储：日志提取允许用户按集群,分区,应用过滤特定的日志,再按过滤条件(开头,正则,包含)对日志进行过滤, 最后将非结构化的应用日志按其种格式对特定的部分进行提取,当前平台支持dissect、grok、json等提取类型。
	* 在提取数据过程中按一定的条件进行报警通知。
	* 提取的IP类型自动转换为地理位置。
	* 用户可对提取后日志结合kibana进行数据统计与图表绘制。
* 日志下载
	* 按照集群、分区、应用、实例、检索条件下载日志。

# 典型场景示例

## 场景一、日志检索与上下文
* 通过日志搜索入口进入日志搜索功能；
* 在输入框中输入想要检索的关键字，进行检索；
* 点击搜索结果中高亮的关键字，可以查看该条日志的上下文。 
![](/images/console-log/日志检索.png)
![](/images/console-log/日志上下文.png)

## 场景二、从Trace找日志
* 点击某个想要查看的请求；
* 点击请求中的某一步，就可以在详情中看到日志了；
![](/images/console-log/trace-log1.png)
![](/images/console-log/trace-log2.png)

## 场景三、从日志到Trace
* 找到自己关注那条日志；
* 点击蓝色的TID部分，即可跳转链路追踪查看Trace信息。
![](/images/console-log/trace1.png)
![](/images/console-log/trace2.png)

## 场景四、日志处理
* 创建处理规则
* 在Kibana界面查看提取的数据
![](/images/console-log/log-handle1.png)
![](/images/console-log/log-handle-view.png)
![](/images/console-log/日志kibana视图.png)

# 总结
